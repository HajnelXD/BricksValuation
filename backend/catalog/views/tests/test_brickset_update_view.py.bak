"""Tests for BrickSetUpdateView PATCH endpoint."""
from __future__ import annotations

from rest_framework import status
from rest_framework.test import APITestCase, APIRequestFactory
from django.contrib.auth import get_user_model
from django.urls import reverse_lazy

from catalog.models import BrickSet, Completeness, ProductionStatus
from valuation.models import Valuation
from catalog.views.brickset_update import BrickSetUpdateView


User = get_user_model()


class BrickSetUpdateViewTests(APITestCase):
    """Test BrickSetUpdateView PATCH endpoint."""

    def setUp(self) -> None:
        """Create test users, brickset and factory."""
        self.factory = APIRequestFactory()
        self.view = BrickSetUpdateView.as_view()

        self.owner = User.objects.create_user(
            username="owner",
            email="owner@example.com",
            password="testpass123",
        )
        self.other_user = User.objects.create_user(
            username="other",
            email="other@example.com",
            password="testpass123",
        )

        self.brickset = BrickSet.objects.create(
            owner=self.owner,
            number=12345,
            production_status=ProductionStatus.ACTIVE,
            completeness=Completeness.COMPLETE,
            has_instructions=True,
            has_box=True,
            is_factory_sealed=False,
            owner_initial_estimate=250,
        )

    def _get_update_url(self, brickset_id: int) -> str:
        """Build URL for update endpoint."""
        return reverse_lazy("catalog:brickset-update", args=[brickset_id])

    def test_patch_authenticated_owner_updates_has_box(self) -> None:
        """PATCH by owner updates has_box field."""
        url = self._get_update_url(self.brickset.id)
        request = self.factory.patch(url, {"has_box": False}, format="json")
        request.user = self.owner

        response = self.view(request, pk=self.brickset.id)

        assert response.status_code == status.HTTP_200_OK
        self.brickset.refresh_from_db()
        assert self.brickset.has_box is False

    def test_patch_authenticated_owner_updates_estimate(self) -> None:
        """PATCH by owner updates owner_initial_estimate field."""
        url = self._get_update_url(self.brickset.id)
        request = self.factory.patch(
            url,
            {"owner_initial_estimate": 500},
            format="json",
        )
        request.user = self.owner

        response = self.view(request, pk=self.brickset.id)

        assert response.status_code == status.HTTP_200_OK
        self.brickset.refresh_from_db()
        assert self.brickset.owner_initial_estimate == 500

    def test_patch_authenticated_owner_updates_both_fields(self) -> None:
        """PATCH by owner updates both has_box and owner_initial_estimate."""
        url = self._get_update_url(self.brickset.id)
        request = self.factory.patch(
            url,
            {"has_box": False, "owner_initial_estimate": 450},
            format="json",
        )
        request.user = self.owner

        response = self.view(request, pk=self.brickset.id)

        assert response.status_code == status.HTTP_200_OK
        self.brickset.refresh_from_db()
        assert self.brickset.has_box is False
        assert self.brickset.owner_initial_estimate == 450

    def test_patch_returns_status_ok(self) -> None:
        """PATCH returns 200 OK status."""
        url = self._get_update_url(self.brickset.id)
        request = self.factory.patch(url, {"has_box": False}, format="json")
        request.user = self.owner

        response = self.view(request, pk=self.brickset.id)

        assert response.status_code == status.HTTP_200_OK

    def test_patch_response_structure_matches_detail_dto(self) -> None:
        """PATCH response contains all BrickSetDetailDTO fields."""
        url = self._get_update_url(self.brickset.id)
        request = self.factory.patch(url, {"has_box": False}, format="json")
        request.user = self.owner

        response = self.view(request, pk=self.brickset.id)
        response.render()

        data = response.data
        assert "id" in data
        assert "number" in data
        assert "production_status" in data
        assert "valuations" in data
        assert "valuations_count" in data
        assert "total_likes" in data

    def test_patch_unauthenticated_returns_unauthorized(self) -> None:
        """PATCH without authentication returns 401 Unauthorized."""
        url = self._get_update_url(self.brickset.id)
        request = self.factory.patch(url, {"has_box": False}, format="json")
        request.user = None  # No authentication

        response = self.view(request, pk=self.brickset.id)

        assert response.status_code == status.HTTP_401_UNAUTHORIZED

    def test_patch_non_owner_returns_forbidden(self) -> None:
        """PATCH by non-owner returns 403 Forbidden."""
        url = self._get_update_url(self.brickset.id)
        request = self.factory.patch(url, {"has_box": False}, format="json")
        request.user = self.other_user

        response = self.view(request, pk=self.brickset.id)

        assert response.status_code == status.HTTP_403_FORBIDDEN

    def test_patch_forbidden_not_owner_includes_reason(self) -> None:
        """PATCH forbidden response includes reason field (not_owner)."""
        url = self._get_update_url(self.brickset.id)
        request = self.factory.patch(url, {"has_box": False}, format="json")
        request.user = self.other_user

        response = self.view(request, pk=self.brickset.id)
        response.render()

        assert response.data["reason"] == "not_owner"
        assert "detail" in response.data

    def test_patch_with_other_users_valuations_returns_forbidden(self) -> None:
        """PATCH with other users' valuations returns 403 Forbidden."""
        Valuation.objects.create(
            brickset=self.brickset,
            user=self.other_user,
            value=350,
            currency="PLN",
            likes_count=0,
        )
        url = self._get_update_url(self.brickset.id)
        request = self.factory.patch(url, {"has_box": False}, format="json")
        request.user = self.owner

        response = self.view(request, pk=self.brickset.id)

        assert response.status_code == status.HTTP_403_FORBIDDEN

    def test_patch_forbidden_other_users_includes_reason(self) -> None:
        """PATCH forbidden response includes reason (other_users_valuations_exist)."""
        Valuation.objects.create(
            brickset=self.brickset,
            user=self.other_user,
            value=350,
            currency="PLN",
            likes_count=0,
        )
        url = self._get_update_url(self.brickset.id)
        request = self.factory.patch(url, {"has_box": False}, format="json")
        request.user = self.owner

        response = self.view(request, pk=self.brickset.id)
        response.render()

        assert response.data["reason"] == "other_users_valuations_exist"

    def test_patch_with_owner_valuation_likes_returns_forbidden(self) -> None:
        """PATCH with owner valuation having likes returns 403 Forbidden."""
        Valuation.objects.create(
            brickset=self.brickset,
            user=self.owner,
            value=300,
            currency="PLN",
            likes_count=5,
        )
        url = self._get_update_url(self.brickset.id)
        request = self.factory.patch(url, {"has_box": False}, format="json")
        request.user = self.owner

        response = self.view(request, pk=self.brickset.id)

        assert response.status_code == status.HTTP_403_FORBIDDEN

    def test_patch_forbidden_owner_likes_includes_reason(self) -> None:
        """PATCH forbidden response includes reason (owner_valuation_has_likes)."""
        Valuation.objects.create(
            brickset=self.brickset,
            user=self.owner,
            value=300,
            currency="PLN",
            likes_count=5,
        )
        url = self._get_update_url(self.brickset.id)
        request = self.factory.patch(url, {"has_box": False}, format="json")
        request.user = self.owner

        response = self.view(request, pk=self.brickset.id)
        response.render()

        assert response.data["reason"] == "owner_valuation_has_likes"

    def test_patch_allowed_when_no_valuations(self) -> None:
        """PATCH allowed when no valuations exist."""
        url = self._get_update_url(self.brickset.id)
        request = self.factory.patch(
            url,
            {"has_box": False, "owner_initial_estimate": 600},
            format="json",
        )
        request.user = self.owner

        response = self.view(request, pk=self.brickset.id)

        assert response.status_code == status.HTTP_200_OK
        response.render()
        assert response.data["valuations_count"] == 0

    def test_patch_allowed_when_owner_valuation_zero_likes(self) -> None:
        """PATCH allowed when owner's valuation has 0 likes."""
        Valuation.objects.create(
            brickset=self.brickset,
            user=self.owner,
            value=300,
            currency="PLN",
            likes_count=0,
        )
        url = self._get_update_url(self.brickset.id)
        request = self.factory.patch(url, {"has_box": False}, format="json")
        request.user = self.owner

        response = self.view(request, pk=self.brickset.id)

        assert response.status_code == status.HTTP_200_OK

    def test_patch_nonexistent_id_returns_not_found(self) -> None:
        """PATCH with nonexistent id returns 404 Not Found."""
        url = reverse_lazy("catalog:brickset-update", args=[999999])
        request = self.factory.patch(url, {"has_box": False}, format="json")
        request.user = self.owner

        response = self.view(request, pk=999999)

        assert response.status_code == status.HTTP_404_NOT_FOUND

    def test_patch_not_found_response_includes_detail(self) -> None:
        """PATCH not found response includes detail message."""
        url = reverse_lazy("catalog:brickset-update", args=[999999])
        request = self.factory.patch(url, {"has_box": False}, format="json")
        request.user = self.owner

        response = self.view(request, pk=999999)
        response.render()

        assert "detail" in response.data

    def test_patch_empty_body_returns_bad_request(self) -> None:
        """PATCH with empty body returns 400 Bad Request."""
        url = self._get_update_url(self.brickset.id)
        request = self.factory.patch(url, {}, format="json")
        request.user = self.owner

        response = self.view(request, pk=self.brickset.id)

        assert response.status_code == status.HTTP_400_BAD_REQUEST

    def test_patch_validation_error_includes_field_errors(self) -> None:
        """PATCH validation error includes field-specific errors."""
        url = self._get_update_url(self.brickset.id)
        request = self.factory.patch(
            url,
            {"has_box": "invalid", "owner_initial_estimate": 1_000_000},
            format="json",
        )
        request.user = self.owner

        response = self.view(request, pk=self.brickset.id)

        assert response.status_code == status.HTTP_400_BAD_REQUEST
        response.render()
        assert (
            "has_box" in response.data or
            "owner_initial_estimate" in response.data
        )

    def test_patch_invalid_has_box_type_returns_bad_request(self) -> None:
        """PATCH with invalid has_box type returns 400 Bad Request."""
        url = self._get_update_url(self.brickset.id)
        request = self.factory.patch(url, {"has_box": "yes"}, format="json")
        request.user = self.owner

        response = self.view(request, pk=self.brickset.id)

        assert response.status_code == status.HTTP_400_BAD_REQUEST

    def test_patch_owner_initial_estimate_below_min_returns_bad_request(
        self,
    ) -> None:
        """PATCH with owner_initial_estimate below min (0) returns 400."""
        url = self._get_update_url(self.brickset.id)
        request = self.factory.patch(
            url,
            {"owner_initial_estimate": 0},
            format="json",
        )
        request.user = self.owner

        response = self.view(request, pk=self.brickset.id)

        assert response.status_code == status.HTTP_400_BAD_REQUEST

    def test_patch_owner_initial_estimate_above_max_returns_bad_request(
        self,
    ) -> None:
        """PATCH with owner_initial_estimate above max (999999) returns 400."""
        url = self._get_update_url(self.brickset.id)
        request = self.factory.patch(
            url,
            {"owner_initial_estimate": 1_000_000},
            format="json",
        )
        request.user = self.owner

        response = self.view(request, pk=self.brickset.id)

        assert response.status_code == status.HTTP_400_BAD_REQUEST
